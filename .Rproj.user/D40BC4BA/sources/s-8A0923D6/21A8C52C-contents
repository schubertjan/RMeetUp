library(data.table)
library(ggplot2)


dat <- list(dulux = fread("C:/Users/schubertj/Documents/kantarware/M2M Simulator/R&D/Test Cases/Dulux/AkzoDuluxCubeTables_20190129.csv"),
            estrella = fread("C:/Users/schubertj/Documents/kantarware/M2M Simulator/R&D/Test Cases/Estrella Galicia/ESTRELLAGALICIA.csv"),
            heineken = fread("C:/Users/schubertj/Documents/kantarware/M2M Simulator/R&D/Test Cases/Heineken/HeinekenFranceCubeTables_21stDecember2018.csv"),
            lesfurets = fread("C:/Users/schubertj/Documents/kantarware/M2M Simulator/R&D/Test Cases/Les Furets/LES_FURETS.csv"),
            nivea = fread("C:/Users/schubertj/Documents/kantarware/M2M Simulator/R&D/Test Cases/Nivea/Personal Care Facial Nevia Mexico.csv"),
            toyota = fread("C:/Users/schubertj/Documents/kantarware/M2M Simulator/R&D/Test Cases/Toyota/Toyota_GB_Tracker_CubeTables.csv")
)

for(i in seq_along(names(dat))) {
  names(dat[[i]]) <- gsub(" ","_",names(dat[[i]]))
}

#lapply(dat, function(t) table(t$Annotation_Center_Header))
#extract bought last for Toyota
#metrics <- lapply(dat, function(t) table(t$Annotation_Left_Header))
#lapply(metrics, function(i) {
#  grep(pattern = "bought", ignore.case = TRUE, x = names(i), value = TRUE)
#})
#bl_toyota <- dat$toyota[dat$toyota$Annotation_Left_Header == "Declared use   purchase - Bought last", ]
#bl_toyota <- bl_toyota[, .(Question_Main, Subgroup_Element_Text, Column_Percent)]
#bl_toyota <- bl_toyota[!Question_Main %in% c("Base", "DontCurrently", "DS", "OtherBrand"), ][, Date := as.Date(Subgroup_Element_Text, format = "%Y%m%d")][, Subgroup_Element_Text := NULL]
#sum(bl_toyota[, .N, by = .(Date,Question_Main)]$N) == dim(bl_toyota)[1]
#bl_toyota[, c("Column_Percent", "Question_Main") := list(as.numeric(Column_Percent),
#                                                         as.factor(Question_Main))]
#bl_toyota <- bl_toyota[, .(Date, Question_Main, Column_Percent)]
#bl_toyota <- dcast(bl_toyota, Date ~ Question_Main, value.var = "Column_Percent")
#colSel <- names(colSums(bl_toyota[, 2:ncol(bl_toyota)]))[colSums(bl_toyota[, 2:ncol(bl_toyota)]) != 0]
#bl_toyota <- bl_toyota[, c("Date", colSel), with = FALSE]


dat <- lapply(dat, function(i) {
  i[grepl("Communication", Annotation_Left_Header, ignore.case = TRUE), ][, .(Question_Main, Subgroup_Element_Text, Column_Percent, Annotation_Left_Header)]
})
lapply(dat, function(t) table(t$Annotation_Left_Header))


tbca_indx <- c("",
               "Communication awareness - TBCA",
               "Communication awareness - Advertising awareness",
               "Communication awareness - TBCA",
               "",
               "Communication awareness - TBCA")

#remove cols
for (i in 1: length(dat)) {
  tryCatch({
  dat[[i]] <- dat[[i]][Annotation_Left_Header == tbca_indx[i], ] #select relevant tbca metrics
  dat[[i]] <- dat[[i]][!Question_Main %in% c("Base", "NoneOfThese") & !is.na(Question_Main), ] #remove brands
  dat[[i]] <- dat[[i]][, .(Brand = Question_Main, Date = Subgroup_Element_Text, Question = Annotation_Left_Header, Value = as.numeric(Column_Percent))] #rename columns
  dat[[i]][, Date := as.Date(Date, format = "%Y%m%d")] #format data
  }, error = function(e){})
}

lapply(dat, function(i) {
  if(nrow(i) == 0) TRUE
})
dat$dulux <- NULL
dat$nivea <- NULL

#merge
dat <- do.call(rbind, c(dat, idcol = TRUE))
names(dat)[1] <- "Project_name"

#add month
dat[, Month := format(Date, format = "%m")]
dat[, Value_scale := scale(Value), by = .(Brand, Project_name)] #scale and remove
dat <- dat[!is.na(Value_scale), ]

ggplot(data = dat, aes(x = Month, y = Value_scale)) + 
  geom_boxplot()+ 
  facet_grid(Brand ~ .)

#monthly
dat_monthly <- dat[, .(Value = mean(Value_scale)), by = .(Brand, Month)]

ggplot(data = dat_monthly, aes(x = Month, y = Value, colour = Brand, group = Brand)) + 
  geom_point() + 
  geom_smooth(se = FALSE) + 
  theme(legend.position="none")

ggplot(data = dat_monthly, aes(x = Month, y = Value)) + 
  geom_line() + 
  facet_grid(Brand ~ . )
